<!DOCTYPE html>
<html lang="en">
    <link rel="stylesheet" href="styles.css"></link>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artspace Lifespace - Booking Enquiry</title>
</head>
<body>

    <div class="accessibility-banner">
        <p>Need help? Use the chatbot prototype or jump to the enquiry form.</p>
        <div class="toggle-buttons">
            <button id="increase-text">Increase Text Size</button>
            <button id="high-contrast">High Contrast Mode</button>
        </div>
    </div>

    <header class="container">
        <div class="logo">ASLS</div>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="Spaces.html">Spaces</a></li>
                <li><a href="About.html">About</a></li>
                <li><a href="Enquire.html">Enquire</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <section id="enquire" class="enquiry-form">
            <h2>Booking Enquiry</h2>
            <form id="main-enquiry-form">
                <label for="name">Name</label>
                <input type="text" id="name" required>
                
                <label for="email">Email</label>
                <input type="email" id="email" required>

                <label for="building">Building</label>
                <select id="building" required>
                    <option value="">Select a venue</option>
                    <option value="the-island">The Island</option>
                    <option value="arts-mansion">Arts Mansion</option>
                    <option value="sparks-bristol">Sparks Bristol</option>
                </select>

                <label for="message">Message</label>
                <textarea id="message" rows="5" required></textarea>

                <button type="submit">Submit Enquiry</button>
            </form>
        </section>
    </div>

    <div id="chat-window">
        <div class="chat-header">
            <span>Artspace Lifespace AI Assistant</span>
            <span style="cursor:pointer" onclick="toggleChat()">‚úñ</span>
        </div>
        <div id="chat-box" class="chat-messages">
            <div class="message bot-msg">Hello! I'm the Artspace Lifespace Assistant. Before we start, what's your name?</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="user-chat-input" placeholder="Type a message...">
            <button onclick="processChat()">Send</button>
        </div>
    </div>

    <div class="chatbot-launcher" onclick="toggleChat()" aria-label="Open chatbot">üí¨</div>

    <footer>
        <p>Contact: info@artspacelifespace.org | Registered Charity Number: 1168150</p>
    </footer>

    <script>
        // Knowledge base for general queries
        const knowledgeCategories = [
            {
                id: "who are we?",
                keywords: ["who", "asls", "artspace", "lifespace", "charity", "mission", "about"],
                response: "Artspace Lifespace (ASLS) is a Bristol-based charity that recycles vacant buildings into creative resources like studios and event spaces."
            },
            {
                id: "venues",
                keywords: ["venue", "space", "island", "mansion", "sparks", "location", "where", "building"],
                response: "We manage several unique venues: The Island, Arts Mansion, Sparks Bristol, and The Vestibules. Each offers unique character and amenities for creative events."
            },
            {
                id: "accessibility",
                keywords: ["access", "disabled", "wheelchair", "step-free", "inclusive"],
                response: "Artspace Lifespace is committed to inclusivity. Many sites like Sparks offer step-free access and quiet spaces. Let us know your specific needs!"
            },
            {
                id: "project info",
                keywords: ["project", "prototype", "bot", "system", "support"],
                response: "This chatbot is a prototype supporting a new digital enquiry system to help users find info and route requests efficiently."
            },
            {   
                id: "Contact Info",
                keywords: ["contact", "email", "phone", "address", "phone number", "reach"],
                response: "For general inquiries, email info@artspacelifespace.org or call +441173763457."
            },
        ];

        // Venue information for detailed queries
        const venueDetails = {
            "the-island": {
                name: "The Island",
                capacity: "50-100 people",
                features: "Waterfront location, outdoor space, natural lighting",
                suitable: "Workshops, exhibitions, small gatherings"
            },
            "arts-mansion": {
                name: "Arts Mansion",
                capacity: "100-200 people",
                features: "Historic building, multiple rooms, high ceilings",
                suitable: "Art shows, performances, conferences"
            },
            "sparks-bristol": {
                name: "Sparks Bristol",
                capacity: "30-80 people",
                features: "Modern facilities, step-free access, tech-equipped",
                suitable: "Meetings, creative workshops, screenings"
            }
        };

        // Chat state management
        let userName = "";
        let userEmail = "";
        let bookingState = "idle"; 
        let tempBookingData = {};
        let currentStep = 0;

        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.style.display = (win.style.display === 'flex') ? 'none' : 'flex';
        }

        function addMessage(text, isUser, isHTML = false) {
            const chatBox = document.getElementById('chat-box');
            const msgDiv = document.createElement('div');
            msgDiv.className = isUser ? 'message user-msg' : 'message bot-msg';
            if (isHTML) msgDiv.innerHTML = text; else msgDiv.innerText = text;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showOptions() {
            let optionsHTML = `
                <div style="margin-bottom: 8px;"><strong>Choose a topic:</strong></div>
                <button class="option-button" onclick="selectOption('who are we?')">Who are we?</button>
                <button class="option-button" onclick="selectOption('venues')">Our Venues</button>
                <button class="option-button" onclick="startBooking()">üìÖ Book an Event</button>
                <button class="option-button" onclick="selectOption('accessibility')">Accessibility</button>
                <button class="option-button" onclick="selectOption('Contact Info')">Contact Info</button>
            `;
            addMessage(optionsHTML, false, true);
        }

        function findResponse(input) {
            const lowerInput = input.toLowerCase();
            for (const cat of knowledgeCategories) {
                if (cat.keywords.some(kw => lowerInput.includes(kw))) return cat.response;
            }
            return null;
        }

        function selectOption(choice) {
            addMessage(choice, true);
            const response = findResponse(choice);
            addMessage(response || "I'm not sure about that. Let me show you the main menu.", false);
            setTimeout(() => {
                addMessage(`<button class="option-button" onclick="showOptions()">‚¨ÖÔ∏è Back to main menu</button>`, false, true);
            }, 800);
        }

        // Booking flow functions
        function startBooking() {
            addMessage("Book an Event", true);
            bookingState = "collecting";
            currentStep = 0;
            tempBookingData = { name: userName, email: userEmail };
            
            addMessage("Great! I'll help you book an event. Let me collect some details.", false);
            setTimeout(() => askNextBookingQuestion(), 500);
        }

        function askNextBookingQuestion() {
            switch(currentStep) {
                case 0:
                    if (!userName) {
                        addMessage("First, what's your name?", false);
                    } else {
                        tempBookingData.name = userName;
                        currentStep++;
                        askNextBookingQuestion();
                    }
                    break;
                case 1:
                    if (!userEmail) {
                        addMessage("What's your email address?", false);
                    } else {
                        tempBookingData.email = userEmail;
                        currentStep++;
                        askNextBookingQuestion();
                    }
                    break;
                case 2:
                    let venueHTML = `
                        <div style="margin-bottom: 8px;"><strong>Which venue would you like to book?</strong></div>
                        <button class="option-button" onclick="selectVenue('the-island')">The Island</button>
                        <button class="option-button" onclick="selectVenue('arts-mansion')">Arts Mansion</button>
                        <button class="option-button" onclick="selectVenue('sparks-bristol')">Sparks Bristol</button>
                        <button class="option-button" onclick="showVenueDetails()">‚ÑπÔ∏è Tell me more about the venues</button>
                    `;
                    addMessage(venueHTML, false, true);
                    break;
                case 3:
                    addMessage("What type of event are you planning? (e.g., workshop, exhibition, performance, meeting)", false);
                    break;
                case 4:
                    addMessage("How many people do you expect to attend?", false);
                    break;
                case 5:
                    addMessage("What date would you prefer? (e.g., March 15, 2026)", false);
                    break;
                case 6:
                    addMessage("Any additional requirements or questions? (Type 'none' if not)", false);
                    break;
                case 7:
                    showBookingSummary();
                    break;
            }
        }

        function showVenueDetails() {
            addMessage("Tell me more about the venues", true);
            let detailsHTML = `
                <div style="background: #f9f9f9; padding: 10px; border-radius: 8px; margin: 8px 0;">
                    <strong>üèõÔ∏è The Island</strong><br>
                    Capacity: ${venueDetails["the-island"].capacity}<br>
                    Features: ${venueDetails["the-island"].features}<br>
                    Suitable for: ${venueDetails["the-island"].suitable}<br><br>
                    
                    <strong>üé® Arts Mansion</strong><br>
                    Capacity: ${venueDetails["arts-mansion"].capacity}<br>
                    Features: ${venueDetails["arts-mansion"].features}<br>
                    Suitable for: ${venueDetails["arts-mansion"].suitable}<br><br>
                    
                    <strong>‚ú® Sparks Bristol</strong><br>
                    Capacity: ${venueDetails["sparks-bristol"].capacity}<br>
                    Features: ${venueDetails["sparks-bristol"].features}<br>
                    Suitable for: ${venueDetails["sparks-bristol"].suitable}
                </div>
                <div style="margin-top: 8px;">
                    <button class="option-button" onclick="askNextBookingQuestion()">Choose a venue</button>
                </div>
            `;
            addMessage(detailsHTML, false, true);
        }

        function selectVenue(venueId) {
            const venue = venueDetails[venueId];
            tempBookingData.building = venueId;
            tempBookingData.venueName = venue.name;
            
            addMessage(venue.name, true);
            addMessage(`Excellent choice! ${venue.name} features: ${venue.features}. Capacity: ${venue.capacity}. Suitable for: ${venue.suitable}`, false);
            
            currentStep++;
            setTimeout(() => askNextBookingQuestion(), 800);
        }

        function showBookingSummary() {
            let summary = `
                <div style="background: #f0f8ff; padding: 12px; border-radius: 8px; margin: 8px 0;">
                    <strong>üìã Booking Summary:</strong><br>
                    <strong>Name:</strong> ${tempBookingData.name}<br>
                    <strong>Email:</strong> ${tempBookingData.email}<br>
                    <strong>Venue:</strong> ${tempBookingData.venueName}<br>
                    <strong>Event Type:</strong> ${tempBookingData.eventType}<br>
                    <strong>Attendees:</strong> ${tempBookingData.attendees}<br>
                    <strong>Preferred Date:</strong> ${tempBookingData.date}<br>
                    ${tempBookingData.message !== 'none' ? `<strong>Additional Notes:</strong> ${tempBookingData.message}<br>` : ''}
                </div>
                <div style="margin-top: 12px;">
                    <button class="option-button" onclick="confirmBooking()">‚úÖ Confirm & Submit</button>
                    <button class="option-button" onclick="cancelBooking()">‚ùå Cancel</button>
                </div>
            `;
            addMessage(summary, false, true);
        }

        function confirmBooking() {
            addMessage("Confirm & Submit", true);
            
            // Populate the form
            document.getElementById('name').value = tempBookingData.name;
            document.getElementById('email').value = tempBookingData.email;
            document.getElementById('building').value = tempBookingData.building;
            
            let formMessage = `Event Type: ${tempBookingData.eventType}\n`;
            formMessage += `Expected Attendees: ${tempBookingData.attendees}\n`;
            formMessage += `Preferred Date: ${tempBookingData.date}\n`;
            if (tempBookingData.message !== 'none') {
                formMessage += `Additional Notes: ${tempBookingData.message}`;
            }
            document.getElementById('message').value = formMessage;
            
            addMessage("‚úÖ Perfect! I've filled out the booking form for you. Please review and submit it below.", false);
            addMessage("The page will scroll to the form in a moment...", false);
            
            // Reset booking state
            bookingState = "idle";
            tempBookingData = {};
            currentStep = 0;
            
            // Scroll to form
            setTimeout(() => {
                document.getElementById('enquire').scrollIntoView({ behavior: 'smooth' });
                // Highlight the form briefly
                const form = document.getElementById('enquire');
                form.style.border = '3px solid #4CAF50';
                setTimeout(() => {
                    form.style.border = '';
                }, 2000);
            }, 1500);
        }

        function cancelBooking() {
            addMessage("Cancel", true);
            addMessage("No problem! Booking cancelled. How else can I help you?", false);
            bookingState = "idle";
            tempBookingData = {};
            currentStep = 0;
            setTimeout(() => showOptions(), 800);
        }

        function processChat() {
            const inputField = document.getElementById('user-chat-input');
            const userInput = inputField.value.trim();
            if (!userInput) return;

            addMessage(userInput, true);
            inputField.value = "";

            // Handle initial name collection
            if (!userName) {
                userName = userInput;
                addMessage(`Nice to meet you, ${userName}! How can I assist you today?`, false);
                showOptions(); 
                return;
            }

            // Handle booking flow
            if (bookingState === "collecting") {
                switch(currentStep) {
                    case 0:
                        tempBookingData.name = userInput;
                        userName = userInput;
                        currentStep++;
                        askNextBookingQuestion();
                        break;
                    case 1:
                        if (validateEmail(userInput)) {
                            tempBookingData.email = userInput;
                            userEmail = userInput;
                            currentStep++;
                            askNextBookingQuestion();
                        } else {
                            addMessage("Please enter a valid email address (e.g., name@example.com)", false);
                        }
                        break;
                    case 3:
                        tempBookingData.eventType = userInput;
                        currentStep++;
                        askNextBookingQuestion();
                        break;
                    case 4:
                        tempBookingData.attendees = userInput;
                        currentStep++;
                        askNextBookingQuestion();
                        break;
                    case 5:
                        tempBookingData.date = userInput;
                        currentStep++;
                        askNextBookingQuestion();
                        break;
                    case 6:
                        tempBookingData.message = userInput;
                        currentStep++;
                        askNextBookingQuestion();
                        break;
                }
                return;
            }

            // Handle general queries
            const lowerInput = userInput.toLowerCase();
            
            // Check for booking intent
            if (lowerInput.includes('book') || lowerInput.includes('reserve') || 
                lowerInput.includes('hire') || lowerInput.includes('event')) {
                startBooking();
                return;
            }

            // Check for venue information requests
            if (lowerInput.includes('venue') && (lowerInput.includes('info') || 
                lowerInput.includes('detail') || lowerInput.includes('tell me'))) {
                showVenueDetails();
                return;
            }

            const response = findResponse(userInput);
            if (response) {
                addMessage(response, false);
                setTimeout(() => {
                    addMessage(`<button class="option-button" onclick="showOptions()">‚¨ÖÔ∏è Back to main menu</button>`, false, true);
                }, 800);
            } else {
                addMessage(`I'm not sure about that, ${userName}. Let me show you what I can help with:`, false);
                setTimeout(() => showOptions(), 500);
            }
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // Event listeners
        document.getElementById('high-contrast').addEventListener('click', () => document.body.classList.toggle('high-contrast'));
        document.getElementById('increase-text').addEventListener('click', () => document.body.classList.toggle('large-text'));
        document.getElementById('user-chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') processChat(); });
        
        // CSV storage functionality
        let allBookings = [];

        // Load existing bookings from localStorage
        function loadBookings() {
            const stored = localStorage.getItem('artspace_bookings');
            if (stored) {
                allBookings = JSON.parse(stored);
            }
        }

        // Save bookings to localStorage
        function saveBookings() {
            localStorage.setItem('artspace_bookings', JSON.stringify(allBookings));
        }

        // Convert bookings array to CSV format
        function convertToCSV(bookings) {
            if (bookings.length === 0) return '';
            
            // CSV headers
            const headers = ['Timestamp', 'Name', 'Email', 'Venue', 'Event Type', 'Attendees', 'Preferred Date', 'Message'];
            
            // CSV rows
            const rows = bookings.map(booking => {
                return [
                    booking.timestamp,
                    `"${booking.name.replace(/"/g, '""')}"`,
                    booking.email,
                    `"${booking.venue.replace(/"/g, '""')}"`,
                    `"${(booking.eventType || '').replace(/"/g, '""')}"`,
                    booking.attendees || '',
                    `"${(booking.preferredDate || '').replace(/"/g, '""')}"`,
                    `"${booking.message.replace(/"/g, '""')}"`
                ].join(',');
            });
            
            return headers.join(',') + '\n' + rows.join('\n');
        }

        // Download CSV file
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function getVenueName(venueId) {
            const venueNames = {
                'the-island': 'The Island',
                'arts-mansion': 'Arts Mansion',
                'sparks-bristol': 'Sparks Bristol'
            };
            return venueNames[venueId] || venueId;
        }

        // Parse message to extract booking details
        function parseBookingMessage(message) {
            const details = {
                eventType: '',
                attendees: '',
                preferredDate: ''
            };
            
            const lines = message.split('\n');
            lines.forEach(line => {
                if (line.startsWith('Event Type:')) {
                    details.eventType = line.replace('Event Type:', '').trim();
                } else if (line.startsWith('Expected Attendees:')) {
                    details.attendees = line.replace('Expected Attendees:', '').trim();
                } else if (line.startsWith('Preferred Date:')) {
                    details.preferredDate = line.replace('Preferred Date:', '').trim();
                }
            });
            
            return details;
        }

        // Initialize bookings on page load
        loadBookings();

        // Form submission handler
        document.getElementById('main-enquiry-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Get form data
            const message = document.getElementById('message').value;
            const bookingDetails = parseBookingMessage(message);
            
            const newBooking = {
                timestamp: new Date().toLocaleString(),
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                venue: getVenueName(document.getElementById('building').value),
                eventType: bookingDetails.eventType,
                attendees: bookingDetails.attendees,
                preferredDate: bookingDetails.preferredDate,
                message: message
            };
            
            // Add to bookings array
            allBookings.push(newBooking);
            
            // Save to localStorage (for ASLS admin access)
            saveBookings();
            
            // Show success message to user (without mentioning CSV)
            alert(`Thank you for your enquiry, ${newBooking.name}! We will get back to you shortly.`);
            
            // In a real application, this would also send data to a server
            // Example: sendBookingToServer(newBooking);
            
            // Reset the form
            document.getElementById('main-enquiry-form').reset();
        });
    </script>
</body>
</html>
